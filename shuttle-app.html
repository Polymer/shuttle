<link rel="import" href="../../../polymer-elements/polymer-grid-layout/polymer-grid-layout.html">
<link rel="import" href="../../../polymer-elements/polymer-media-query/polymer-media-query.html">
<link rel="import" href="../../../polymer-ui-elements/polymer-ui-icon/polymer-ui-icon.html">
<link rel="import" href="../../../polymer-ui-elements/polymer-ui-tabs/polymer-ui-tabs.html">
<link rel="import" href="../../../polymer-ui-elements/polymer-ui-overlay/polymer-ui-overlay.html">
<link rel="import" href="shuttle-data.html">
<link rel="import" href="shuttle-schedule.html">
<link rel="import" href="shuttle-favorites.html">
<link rel="import" href="shuttle-map.html">
  
<polymer-element name="shuttle-app">
  <template>
    <style>
      @host {
        * {
          -webkit-user-select: none;
          -moz-user-select: none;
          -ms-user-select: none;
          user-select: none;
        }
      }
      
      #tabbar {
        border-top: 1px solid #bababa;
        height: 46px !important;
        bottom: 0;
      }
      
      #tabbar > * {
        display: block;
        height: 45px !important;
        line-height: 45px !important;
        text-align: center;
        width: 160px;
      }
      
      #tabbar > [hidden] {
        display: none !important;
      }
      
      #tabbar > .polymer-selected {
        background-color: #ccc !important;
      }
      
      #tabbar > * {
        text-align: center;
      }
      
      #main {
        position: relative;
        width: 300px;
        margin: 20px;
        max-height: 88%;
        overflow: hidden;
      }
      
      #main::x-overlay {
        background: transparent;
      }
      
      #schedule.hidden, #favorites.hidden {
        display: none !important;
      }
      
      @media screen and (max-width: 360px) {
        #main {
          width: auto;
          right: 0;
        }
      }
    </style>

    <polymer-media-query query="max-width: 800px" queryMatches="{{queryMatches}}"></polymer-media-query>
    <shuttle-data id="data" route="{{route}}" officeStops="{{officeStops}}" remoteStops="{{remoteStops}}" favorites="{{favorites}}"></shuttle-data>

    <polymer-ui-overlay id="main" modal active>
      <shuttle-schedule id="schedule" route="{{route}}" officeStops="{{officeStops}}" remoteStops="{{remoteStops}}" 
          centerStop="{{centerStop}}" fromStop="{{fromStop}}" toStop="{{toStop}}" 
          favorites="{{favorites}}" favorite="{{favorite}}" filteredStops="{{filteredStops}}" 
          selectedFilteredStop="{{selectedFilteredStop}}" on-shuttle-data-save="saveData"></shuttle-schedule>
      <shuttle-favorites id="favorites" favorites="{{favorites}}" favorite="{{favorite}}" 
          on-polymer-activate="favoriteSelect" on-shuttle-favorites-change="favoritesChange"></shuttle-favorites>
    </polymer-ui-overlay>
    
    <div id="basement">
      <polymer-grid-layout nodes="{{nodes}}" layout="{{layout}}"></polymer-grid-layout>
      <shuttle-map id="map" class="{{desktop : !queryMatches}}" centerStop="{{centerStop}}" 
          fromStop="{{fromStop}}" toStop="{{toStop}}"
          filteredStops="{{filteredStops}}" selectedFilteredStop="{{selectedFilteredStop}}"></shuttle-map>
      <polymer-ui-tabs id="tabbar" theme="polymer-ui-light-theme" selected="{{selected}}">
        <div flex?="{{queryMatches}}"><polymer-ui-icon icon="time"></polymer-ui-icon></div>
        <div flex?="{{queryMatches}}"><polymer-ui-icon icon="favorite"></polymer-ui-icon></div>
      </polymer-ui-tabs>
    </div>
  </template>
  <script>
    Polymer('shuttle-app', {
      selected: null,
      queryMatches: false,
      created: function() {
        this.nodes = [
          this.$.map, this.$.tabbar
        ];
        this.layout = [
          [1],
          [1], 
          [2]
        ];
        this.selected = 0;
        window.addEventListener('resize', function() {
          this.$.map.resize();
        }.bind(this));
      },
      queryMatchesChanged: function() {
      },
      selectedChanged: function() {
        this.$.schedule.classList.toggle('hidden', this.selected);
        this.$.favorites.classList.toggle('hidden', !this.selected);
        if (this.selected) {
          this.$.favorites.clearSelection();
        }
      },
      favoriteSelect: function() {
        this.selected = 0;
      },
      favoritesChange: function() {
        this.$.schedule.updateFav();
        this.saveData();
      },
      saveData: function() {
        this.$.favorites.clearSelection();
        this.$.data.save();
      }
    });
  </script>
</polymer-element>