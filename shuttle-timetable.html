<polymer-element name="shuttle-timetable" attributes="fromStop toStop fromStops toStops">
  <template>
    <link rel="stylesheet" href="../../../polymer-elements/polymer-flex-layout/polymer-flex-layout.css">
    <style>
      .stops {
        padding-left: 20px;
      }
      
      .stops > .header {
        height: 40px;
        line-height: 40px;
        font-size: 13px;
        font-weight: bold;
      }
      
      .time {
        height: 40px;
        line-height: 40px;
        font-size: 14px;
        opacity: 0.5;
      }
      
      .time[avail] {
        opacity: 1;
        font-weight: bold;
      }
      
      .time[dog]:after {
        content: '*';
        padding-left: 4px;
      }
    </style>
    
    <div flexbox>
      <div class="stops" flex>
        <div class="header">Depart</div>
        <template repeat="{{fs in fromStops}}">
          <div class="time" avail?="{{fs.date >= now}}" dog?="{{fs.dog}}">{{fs.time}} </div>
        </template>
      </div>
      <div class="stops" flex>
        <div class="header">Arrive</div>
        <template repeat="{{ts in toStops}}">
          <div class="time" avail?="{{ts.date >= now}}" dog?="{{ts.dog}}">{{ts.time}}</div>
        </template>
      </div>
    </div>
  </template>
  <script>
    Polymer('shuttle-timetable', {
      fromStopChanged: function() {
        this.updateTimetable();
      },
      toStopChanged: function() {
        this.updateTimetable();
      },
      updateTimetable: function() {
        if (!this.fromStop || !this.toStop) {
          return;
        }
        this.now = new Date();
        // find trips that will stop in fromStop and toStop
        var trips = [];
        this.fromStop.trips.forEach(function(t) {
          if (this.toStop.trips.indexOf(t) >= 0) {
            trips.push(t);
          }
        }, this);
        // find all the stops in the trip that stop at fromStop/toStop
        this.fromStops = [];
        this.toStops = []; 
        for (var i = 0, trip; trip = Shuttle.trips[trips[i]]; i++) {
          if (this.isOutbound(trip)) {
            var dog = trip.name.search(/dog/i) > -1;
            for (var j = 0, stop; stop = trip.stops[j]; j++) {
              var ds = (new Date()).toDateString();
              stop.date = new Date(ds + ' ' + stop.time);
              stop.dog = dog;
              if (stop.stop == this.fromStop.index) {
                this.fromStops.push(stop);
              } else if (stop.stop == this.toStop.index) {
                this.toStops.push(stop);
              }
            }
          }
        }
      },
      isOutbound: function(trip) {
        for (var i = 0, stop; stop = trip.stops[i]; i++) {
          if (stop.stop === this.fromStop.index) {
            return true;
          } else if (stop.stop === this.toStop.index) {
            return false;
          }
        }
      }
    });
  </script>
</polymer-element>